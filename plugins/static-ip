#!/usr/bin/env bash

# Check if script is run as root
if [[ $EUID -ne 0 ]]; then
   echo "This script must be run as root. Use sudo."
   exit 1
fi

# File to modify
INTERFACES_FILE="/etc/network/interfaces"

# Find interface using DHCP
INTERFACE=$(grep -E "^iface.*inet dhcp" "$INTERFACES_FILE" | awk '{print $2}')

# Check if an interface with DHCP was found
if [[ -z "$INTERFACE" ]]; then
    echo "Error: No interface with DHCP configuration found in $INTERFACES_FILE."
    echo "Please check the file or configure the interface manually."
    exit 1
fi

# Default values
DEFAULT_IP="192.168.11.100"
DEFAULT_NETMASK="255.255.255.0"
DEFAULT_GATEWAY="192.168.11.1"
DEFAULT_DNS="192.168.11.1"

# Prompt for network details with defaults
read -p "Enter static IP address (default: $DEFAULT_IP): " IP_ADDRESS
IP_ADDRESS=${IP_ADDRESS:-$DEFAULT_IP}
read -p "Enter netmask (default: $DEFAULT_NETMASK): " NETMASK
NETMASK=${NETMASK:-$DEFAULT_NETMASK}
read -p "Enter gateway (default: $DEFAULT_GATEWAY): " GATEWAY
GATEWAY=${GATEWAY:-$DEFAULT_GATEWAY}
read -p "Enter DNS servers (space-separated, default: $DEFAULT_DNS): " DNS_SERVERS
DNS_SERVERS=${DNS_SERVERS:-$DEFAULT_DNS}

# Validate input
if [[ -z "$IP_ADDRESS" || -z "$NETMASK" || -z "$GATEWAY" || -z "$DNS_SERVERS" ]]; then
    echo "All fields are required. Exiting."
    exit 1
fi

# Backup existing interfaces file
BACKUP_FILE="/etc/network/interfaces.bak_$(date +%F_%H-%M-%S)"
if [[ -f "$INTERFACES_FILE" ]]; then
    cp "$INTERFACES_FILE" "$BACKUP_FILE"
    echo "Backed up existing configuration to $BACKUP_FILE"
else
    echo "Error: $INTERFACES_FILE not found. Exiting."
    exit 1
fi

# Replace DHCP configuration with static
if grep -q "iface $INTERFACE inet dhcp" "$INTERFACES_FILE"; then
    sed -i "/iface $INTERFACE inet dhcp/c\
iface $INTERFACE inet static\n\
    address $IP_ADDRESS\n\
    netmask $NETMASK\n\
    gateway $GATEWAY\n\
    dns-nameservers $DNS_SERVERS" "$INTERFACES_FILE"
else
    echo "Error: DHCP configuration for $INTERFACE not found during replacement."
    echo "Restoring backup and exiting."
    cp "$BACKUP_FILE" "$INTERFACES_FILE"
    exit 1
fi

# Check if modification was successful
if [[ $? -eq 0 ]]; then
    echo "Static IP configuration for $INTERFACE written to $INTERFACES_FILE"
else
    echo "Failed to write configuration. Restoring backup."
    cp "$BACKUP_FILE" "$INTERFACES_FILE"
    exit 1
fi

# Restart networking service
echo "Restarting networking service..."
systemctl restart networking || {
    echo "Failed to restart networking. Please restart manually or reboot."
    exit 1
}

echo "Static IP address configured successfully for $INTERFACE!"
echo "IP Address: $IP_ADDRESS"
echo "Netmask: $NETMASK"
echo "Gateway: $GATEWAY"
echo "DNS Servers: $DNS_SERVERS"

exit 0
